<div class="home-container">
  <!-- Main Feed -->
  <main class="main-feed">
    <!-- Create Post Card -->
    <mat-card class="create-post-card" (click)="onCreatePost()">
      <div class="create-post-content">
        <mat-icon class="avatar-placeholder">account_circle</mat-icon>
        <div class="create-input">
          <input type="text" readonly placeholder="Create Post" />
        </div>
        <button mat-icon-button><mat-icon>image</mat-icon></button>
        <button mat-icon-button><mat-icon>link</mat-icon></button>
      </div>
    </mat-card>

    <!-- Sort Bar -->
    <div class="sort-filter-bar">
      <div class="sort-options">
        <button mat-button [class.active]="selectedSort() === 'algorithm'" (click)="onSortChange('algorithm')">Best</button>
        <button mat-button [class.active]="selectedSort() === 'hot'" (click)="onSortChange('hot')">Hot</button>
        <button mat-button [class.active]="selectedSort() === 'new'" (click)="onSortChange('new')">New</button>
        <button mat-button [class.active]="selectedSort() === 'top'" (click)="onSortChange('top')">Top</button>
      </div>
      <button mat-icon-button (click)="refreshFeed()"><mat-icon>refresh</mat-icon></button>
    </div>

    <!-- Search -->
    <mat-card class="search-card">
      <mat-form-field appearance="outline" class="search-field">
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [formControl]="searchControl" placeholder="Search posts" autocomplete="off" />
        @if (searchControl.value) {
          <button mat-icon-button matSuffix type="button" (click)="onClearSearch()">
            <mat-icon>clear</mat-icon>
          </button>
        }
      </mat-form-field>
    </mat-card>

    <!-- Loading -->
    @if (feedService.loading()) {
      <div class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading your personalized feed...</p>
      </div>
    }

    <!-- Error -->
    @if (feedService.error(); as err) {
      <mat-card class="error-card">
        <mat-icon>error_outline</mat-icon>
        <p>{{ err }}</p>
        <button mat-raised-button color="primary" (click)="refreshFeed()">Retry</button>
      </mat-card>
    }

    <!-- Posts -->
    @for (post of feedService.posts(); track post.id) {
      <mat-card class="post-card">
        <div class="post-content">
          <!-- Voting -->
          <div class="voting-section">
            <button mat-icon-button class="vote-btn upvote" [class.voted]="post.userInteraction.hasUpvoted" (click)="onVote(post, 'upvote')">
              <mat-icon>arrow_upward</mat-icon>
            </button>
            <span class="vote-count" [class.upvoted]="post.userInteraction.hasUpvoted" [class.downvoted]="post.userInteraction.hasDownvoted">{{ post.score | formatNumber }}</span>
            <button mat-icon-button class="vote-btn downvote" [class.voted]="post.userInteraction.hasDownvoted" (click)="onVote(post, 'downvote')">
              <mat-icon>arrow_downward</mat-icon>
            </button>
          </div>

          <!-- Body -->
          <div class="post-body">
            <div class="post-header">
              <a class="subreddit-link" [routerLink]="'/r/' + post.subreddit.name">r/{{ post.subreddit.name }}</a>
              <span class="post-meta">
                Posted by
                <a class="author-link" [routerLink]="'/user/' + post.author.username">u/{{ post.author.username }}</a>
                {{ post.createdAt | timeAgo }}
              </span>
              @if (post.flairText) {
                <span class="post-flair">{{ post.flairText }}</span>
              }
              @if (post.isOver18) {
                <span class="post-flair nsfw">NSFW</span>
              }
              @if (post.isSpoiler) {
                <span class="post-flair spoiler">Spoiler</span>
              }
            </div>

            <h3 class="post-title">
              <a [routerLink]="'/posts/' + post.id">{{ post.title }}</a>
            </h3>

            @if (post.content) {
              <p class="post-content-preview">{{ post.content }}</p>
            }

            <div class="post-actions">
              <a class="action-btn" [routerLink]="'/posts/' + post.id">
                <mat-icon>chat_bubble_outline</mat-icon>
                <span>{{ post.commentCount }} Comments</span>
              </a>
              <button class="action-btn">
                <mat-icon>share</mat-icon>
                <span>Share</span>
              </button>
              <button class="action-btn">
                <mat-icon>{{ post.userInteraction.isSaved ? 'bookmark' : 'bookmark_border' }}</mat-icon>
                <span>{{ post.userInteraction.isSaved ? 'Saved' : 'Save' }}</span>
              </button>
            </div>
          </div>
        </div>
      </mat-card>
    }

    <!-- Empty -->
    @if (!feedService.loading() && !feedService.error() && feedService.posts().length === 0) {
      <mat-card class="empty-state">
        <div class="empty-content">
          <mat-icon class="empty-icon">inbox</mat-icon>
          <h3>No posts yet</h3>
          <p>Be the first to create a post or subscribe to communities</p>
          <button mat-raised-button color="primary" (click)="onCreatePost()">Create Post</button>
        </div>
      </mat-card>
    }

    <!-- Load More -->
    @if (feedService.posts().length >= 20 && feedService.hasMore()) {
      <div class="load-more">
        <button mat-stroked-button (click)="loadMore()" [disabled]="feedService.loading()">
          Load More
        </button>
      </div>
    }
  </main>

  <!-- Sidebar -->
  <aside class="sidebar">
    <!-- Home Card -->
    <mat-card class="sidebar-card">
      <div class="card-header"><h3>Home</h3></div>
      <div class="card-content">
        <p class="community-description">
          Your personal Lambrk front page. Come here to check in with your favourite communities.
        </p>
        <mat-divider></mat-divider>
        <button mat-raised-button color="primary" class="full-width sidebar-btn" (click)="onCreatePost()">
          Create Post
        </button>
      </div>
    </mat-card>

    <!-- Suggested Users Card -->
    @if (feedService.suggestedUsers() && feedService.suggestedUsers().length > 0) {
      <mat-card class="sidebar-card">
        <div class="card-header">
          <h3>Recommended Users</h3>
        </div>
        <div class="card-content">
          @for (user of feedService.suggestedUsers(); track user.id) {
            <div class="suggested-user">
              <a [routerLink]="'/user/' + user.username" class="user-link">
                <div class="user-info">
                  @if (user.avatarUrl) {
                    <img [src]="user.avatarUrl" [alt]="user.username" class="user-avatar-sm">
                  } @else {
                    <mat-icon class="user-avatar-placeholder">account_circle</mat-icon>
                  }
                  <div class="user-details">
                    <span class="username">
                      u/{{ user.username }}
                      @if (user.isVerified) {
                        <mat-icon class="verified-icon-sm">verified</mat-icon>
                      }
                    </span>
                    <span class="karma">{{ user.karma | formatNumber }} karma</span>
                  </div>
                </div>
              </a>
              <div class="user-reasons">
                @for (reason of user.reasons; track reason) {
                  <span class="reason-tag">{{ reason }}</span>
                }
              </div>
            </div>
            @if (!$last) {
              <mat-divider class="user-divider"></mat-divider>
            }
          }
        </div>
      </mat-card>
    }

    <!-- Algorithm Stats Card -->
    @if (feedService.algorithmInfo(); as algo) {
      <mat-card class="sidebar-card algorithm-stats">
        <div class="card-header">
          <h3>Feed Stats</h3>
        </div>
        <div class="card-content">
          <div class="stat-row">
            <span class="stat-label">Available Posts:</span>
            <span class="stat-value">{{ feedService.totalAvailable() | formatNumber }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Processing Time:</span>
            <span class="stat-value">{{ algo.processingTimeMs }}ms</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Time Decay:</span>
            <span class="stat-value">{{ algo.timeDecayFactor }}x</span>
          </div>
        </div>
      </mat-card>
    }
  </aside>
</div>

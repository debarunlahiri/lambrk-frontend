<div class="admin-container">
  <h1 class="admin-title">
    <mat-icon>admin_panel_settings</mat-icon>
    Admin Dashboard
  </h1>

  <mat-tab-group animationDuration="0ms">
    <mat-tab label="Perform Action">
      <div class="tab-content">
        <div class="action-grid">
          <mat-card class="action-form-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>gavel</mat-icon>
              <mat-card-title>Admin Action</mat-card-title>
              <mat-card-subtitle>{{ getActionDescription(selectedAction()) }}</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <form [formGroup]="actionForm" (ngSubmit)="onSubmit()">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Action Type</mat-label>
                  <mat-select formControlName="action">
                    @for (action of actionTypes; track action) {
                      <mat-option [value]="action">{{ getActionLabel(action) }}</mat-option>
                    }
                  </mat-select>
                  @if (actionForm.get('action')?.invalid && actionForm.get('action')?.touched) {
                    <mat-error>Action type is required</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Target ID</mat-label>
                  <input matInput type="number" formControlName="targetId" placeholder="Enter user/post/comment ID">
                  @if (actionForm.get('targetId')?.invalid && actionForm.get('targetId')?.touched) {
                    <mat-error>Valid target ID is required</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Reason</mat-label>
                  <textarea matInput formControlName="reason" rows="3" placeholder="Enter reason for this action"></textarea>
                  <mat-hint align="end">{{ actionForm.get('reason')?.value?.length || 0 }}/1000</mat-hint>
                  @if (actionForm.get('reason')?.invalid && actionForm.get('reason')?.touched) {
                    <mat-error>Reason is required (max 1000 chars)</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Notes (Optional)</mat-label>
                  <textarea matInput formControlName="notes" rows="2" placeholder="Additional notes for admin reference"></textarea>
                  <mat-hint align="end">{{ actionForm.get('notes')?.value?.length || 0 }}/1000</mat-hint>
                </mat-form-field>

                @if (actionRequiresDuration.includes(selectedAction())) {
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Duration (Days)</mat-label>
                    <input matInput type="number" formControlName="durationDays" placeholder="Leave empty for permanent">
                    <mat-hint>Temporary action duration in days</mat-hint>
                  </mat-form-field>
                }

                @if (actionSupportsPermanent.includes(selectedAction())) {
                  <mat-checkbox formControlName="permanent" class="checkbox-field">
                    Permanent
                  </mat-checkbox>
                }

                <mat-checkbox formControlName="notifyUser" class="checkbox-field">
                  Notify affected user
                </mat-checkbox>

                <div class="form-actions">
                  <button mat-raised-button color="primary" type="submit" [disabled]="loading()">
                    @if (loading()) {
                      <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                      <mat-icon>check_circle</mat-icon>
                    }
                    {{ loading() ? 'Processing...' : 'Perform Action' }}
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>

          <mat-card class="recent-actions-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>history</mat-icon>
              <mat-card-title>Recent Actions</mat-card-title>
              <mat-card-subtitle>Last 10 actions performed</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              @if (recentActions().length === 0) {
                <div class="empty-recent">
                  <mat-icon>info</mat-icon>
                  <p>No recent actions</p>
                </div>
              } @else {
                <mat-accordion>
                  @for (action of recentActions(); track action.actionId) {
                    <mat-expansion-panel>
                      <mat-expansion-panel-header>
                        <mat-panel-title>
                          <mat-chip [color]="action.isActive ? 'primary' : 'warn'" selected>
                            {{ getActionLabel(action.action) }}
                          </mat-chip>
                        </mat-panel-title>
                        <mat-panel-description>
                          Target: {{ action.targetType }} #{{ action.targetId }}
                        </mat-panel-description>
                      </mat-expansion-panel-header>

                      <div class="action-details">
                        <p><strong>Reason:</strong> {{ action.reason }}</p>
                        @if (action.notes) {
                          <p><strong>Notes:</strong> {{ action.notes }}</p>
                        }
                        <p><strong>Result:</strong> {{ action.result }}</p>
                        <p><strong>Status:</strong> {{ action.isActive ? 'Active' : 'Inactive' }}</p>
                        <p><strong>Performed:</strong> {{ formatTimeAgo(action.performedAt) }}</p>
                      </div>
                    </mat-expansion-panel>
                  }
                </mat-accordion>
              }
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Audit Log">
      <div class="tab-content">
        <mat-card class="audit-log-card">
          <mat-card-header>
            <mat-icon mat-card-avatar>receipt_long</mat-icon>
            <mat-card-title>Admin Audit Log</mat-card-title>
            <mat-card-subtitle>History of all admin actions</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            @if (adminService.loading()) {
              <div class="loading-state">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Loading audit log...</p>
              </div>
            } @else {
              <div class="table-container">
                <table mat-table [dataSource]="auditLog()?.content || []" class="audit-table">
                  <ng-container matColumnDef="actionId">
                    <th mat-header-cell *matHeaderCellDef>ID</th>
                    <td mat-cell *matCellDef="let action">{{ action.actionId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="action">
                    <th mat-header-cell *matHeaderCellDef>Action</th>
                    <td mat-cell *matCellDef="let action">
                      <mat-chip [color]="action.isActive ? 'primary' : 'warn'" selected>
                        {{ getActionLabel(action.action) }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="targetType">
                    <th mat-header-cell *matHeaderCellDef>Target Type</th>
                    <td mat-cell *matCellDef="let action">{{ action.targetType }}</td>
                  </ng-container>

                  <ng-container matColumnDef="targetId">
                    <th mat-header-cell *matHeaderCellDef>Target ID</th>
                    <td mat-cell *matCellDef="let action">{{ action.targetId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="reason">
                    <th mat-header-cell *matHeaderCellDef>Reason</th>
                    <td mat-cell *matCellDef="let action" class="reason-cell">{{ action.reason }}</td>
                  </ng-container>

                  <ng-container matColumnDef="performedAt">
                    <th mat-header-cell *matHeaderCellDef>Time</th>
                    <td mat-cell *matCellDef="let action">{{ formatTimeAgo(action.performedAt) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="isActive">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let action">
                      @if (action.isActive) {
                        <mat-icon color="primary">check_circle</mat-icon>
                      } @else {
                        <mat-icon color="warn">cancel</mat-icon>
                      }
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <mat-paginator
                  [length]="auditLog()?.pageable?.totalElements || 0"
                  [pageSize]="auditLog()?.pageable?.pageSize || 20"
                  [pageIndex]="auditLog()?.pageable?.pageNumber || 0"
                  [pageSizeOptions]="[10, 20, 50]"
                  (page)="onPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
